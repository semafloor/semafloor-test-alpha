<link rel="import" href="../polymer/polymer.html"><link rel="import" href="firebase-query-behavior.html"><script>!function(){"use strict";var e=Polymer({is:"firebase-collection",behaviors:[Polymer.FirebaseQueryBehavior],properties:{query:{type:Object,notify:!0,computed:"_computeQuery(location, limitToFirst, limitToLast, _orderByMethodName, _startAt, _endAt, _equalTo)",observer:"_queryChanged"},data:{type:Array,readOnly:!0,notify:!0,value:function(){return[]}},orderByChild:{type:String,value:null,reflectToAttribute:!0},orderByKey:{type:Boolean,value:!1,reflectToAttribute:!0},orderByValue:{type:Boolean,value:!1,reflectToAttribute:!0},orderByPriority:{type:Boolean,value:!1,reflectToAttribute:!0},limitToFirst:{type:Number,value:null,reflectToAttribute:!0},limitToLast:{type:Number,value:null,reflectToAttribute:!0},startAt:{type:String,value:null,reflectToAttribute:!0},endAt:{type:String,value:null,reflectToAttribute:!0},equalTo:{type:String,value:null,reflectToAttribute:!0},orderValueType:{type:String,value:"string",reflectToAttribute:!0},_valueMap:{type:Object,value:function(){return{}}},_orderByMethodName:{computed:"_computeOrderByMethodName(orderByChild, orderByKey, orderByValue, orderByPriority)"},_orderByTypeCast:{computed:"_computeOrderByTypeCast(orderByChild, orderByKey, orderByValue, orderByPriority, orderValueType)"},_startAt:{computed:"_computeStartAt(startAt, _orderByTypeCast)"},_endAt:{computed:"_computeEndAt(endAt, _orderByTypeCast)"},_equalTo:{computed:"_computeEqualTo(equalTo, _orderByTypeCast)"}},listeners:{"firebase-child-added":"_onFirebaseChildAdded","firebase-child-removed":"_onFirebaseChildRemoved","firebase-child-changed":"_onFirebaseChildChanged","firebase-child-moved":"_onFirebaseChildMoved"},created:function(){this._pendingSplices=[],this._lastLocallyAddedIndex=null},add:function(e){var t;return this._log("Adding new item to collection with value:",e),t=this.query.ref().push(),t.set(e),t},remove:function(e){return null==e||null==e.__firebaseKey__?void this._warn("Refusing to remove unknown value:",e):(this._log('Removing collection item "'+e.__firebaseKey__+'"',e.value),void this.removeByKey(e.__firebaseKey__))},getByKey:function(e){return this._valueMap[e]},removeByKey:function(e){return this.query?void this.query.ref().child(e).remove():void this._error("Cannot remove items before query has been initialized.")},_localDataChanged:function(e){var t=e.path.split(".");if(!(t.length<2||"length"===t[1]))return"splices"===t[1]&&null!=e.value.indexSplices?void this._adoptSplices(e.value.indexSplices):void this._applySubPathChange(e)},_applySubPathChange:function(e){var t=e.path.split(".")[1],i=Polymer.Collection.get(e.base).getItem(t),r=i.__firebaseKey__;i.__firebaseKey__=null,this.query.ref().child(r).set(i),i.__firebaseKey__=r},_adoptSplices:function(e){this._pendingSplices=this._pendingSplices.concat(e),this._applyLocalDataChange(function(){e.forEach(function(e){e.removed.forEach(function(e){this.remove(e)},this)},this)}),this.debounce("_adoptSplices",function(){this._applyLocalDataChange(function(){var e=this._pendingSplices;this._pendingSplices=[],e.forEach(function(e){var t=e.object.slice(e.index,e.index+e.addedCount);t.forEach(function(t,i){this._lastLocallyAddedIndex=e.index+i,this.add(t)},this)},this),this._lastLocallyAddedIndex=null})})},_computeQuery:function(e,t,i,r,a,n,l){var o;if(e)return this._log("Recomputing query.",arguments),o=new Firebase(e),r&&(o="orderByChild"===r?o[r](this.orderByChild):o[r]()),null!=a&&(o=o.startAt(a)),null!=n&&(o=o.endAt(n)),null!=l&&(o=o.equalTo(l)),null!=i&&(o=o.limitToLast(i)),null!=t&&(o=o.limitToFirst(t)),o},_queryChanged:function(){this._valueMap={},this._setData([]),Polymer.FirebaseQueryBehavior._queryChanged.apply(this,arguments)},_computeOrderByMethodName:function(e,t,i,r){return e?"orderByChild":t?"orderByKey":i?"orderByValue":r?"orderByPriority":null},_computeOrderByTypeCast:function(t,i,r,a,n){return function(t){return!i&&null!=t&&e.ORDER_VALUE_TYPES[n]?e.ORDER_VALUE_TYPES[n](t):t}},_computeStartAt:function(e,t){return t(e)},_computeEndAt:function(e,t){return t(e)},_computeEqualTo:function(e,t){return t(e)},_valueFromSnapshot:function(e){var t=e.val();return t instanceof Object||(t={value:t,__firebasePrimitive__:!0}),t.__firebaseKey__=e.key(),t},_valueToPersistable:function(e){var t;if(e.__firebasePrimitive__)return e.value;t={};for(var i in e)"__firebaseKey__"!==i&&(t[i]=e[i]);return t},_onFirebaseChildAdded:function(e){this._applyRemoteDataChange(function(){var t,i=this._valueFromSnapshot(e.detail.childSnapshot),r=(i.__firebaseKey__,e.detail.previousChildName),a=null!=r?this.data.indexOf(this._valueMap[r])+1:0;this._valueMap[i.__firebaseKey__]=i,this._lastLocallyAddedIndex===a?this.set(["data",a],i):(null!=this._lastLocallyAddedIndex&&(t=this.data[this._lastLocallyAddedIndex]),this.splice("data",a,0,i),null!=this._lastLocallyAddedIndex&&this.splice("data",this.data.indexOf(t),1))})},_onFirebaseChildRemoved:function(e){return this._receivingLocalChanges?void(this._valueMap[e.detail.oldChildSnapshot.key()]=null):void this._applyRemoteDataChange(function(){var t,i=e.detail.oldChildSnapshot.key(),r=this._valueMap[i];return r?(t=this.data.indexOf(r),this._valueMap[i]=null,void(-1!==t&&this.splice("data",t,1))):void this._error('Received firebase-child-removed event for unknown child "'+i+'"')})},_onFirebaseChildChanged:function(e){this._applyRemoteDataChange(function(){var t=this._valueFromSnapshot(e.detail.childSnapshot),i=this._valueMap[t.__firebaseKey__];return i?(this._valueMap[i.__firebaseKey__]=null,this._valueMap[t.__firebaseKey__]=t,void this.splice("data",this.data.indexOf(i),1,t)):void this._error('Received firebase-child-changed event for unknown child "'+t.__firebaseKey__+'"')})},_onFirebaseChildMoved:function(e){this._applyRemoteDataChange(function(){var t,i,r,a,n=e.detail.childSnapshot.key(),l=this._valueMap[n];return l?(t=null!=e.detail.previousChildName?this._valueMap[e.detail.previousChildName]:null,r=this.data.indexOf(l),a=t?this.data.indexOf(t):-1,i=r>a?a+1:a,this.splice("data",r,1),void this.splice("data",i,0,l)):void this._error('Received firebase-child-moved event for unknown child "'+n+'"')})}});e.ORDER_VALUE_TYPES={string:String,number:Number,"boolean":Boolean}}();</script>